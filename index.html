<!DOCTYPE html>
<html lang="zh-CN" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间记录器</title>
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏰</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS Dark Mode Configuration
        tailwind.config = {
            darkMode: 'class',
        }
    </script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
        }
        html.dark .tab-button.active {
            border-color: #60a5fa;
            color: #60a5fa;
        }
        .btn-press:active {
            transform: scale(0.98);
            transition: transform 0.1s ease-in-out;
        }
        .regular-active-indicator {
            border-color: #3b82f6 !important; /* blue-500 */
        }
        html.dark .regular-active-indicator {
            border-color: #60a5fa !important; /* blue-400 */
        }
        .countdown-active-indicator {
            border-color: #f59e0b !important; /* amber-500 */
        }
        html.dark .countdown-active-indicator {
            border-color: #fcd34d !important; /* amber-300 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div class="w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8">
             <h1 class="text-3xl sm:text-4xl font-bold">时间<span class="text-blue-500">记录器</span></h1>
            <div class="flex items-center space-x-2">
                <button id="import-btn" title="导入数据" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                </button>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
                <button id="export-btn" title="导出数据" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                </button>
                <button id="theme-toggle-btn" title="切换主题" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-slate-700 focus:outline-none">
                    <!-- Icons will be injected by JS -->
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Left Column: Tasks and Input -->
            <div class="lg:col-span-3 space-y-8">
                <section>
                    <h2 class="text-xl font-bold mb-4">添加新任务</h2>
                    <form id="add-task-form" class="flex items-center space-x-3">
                        <input type="text" id="new-task-input" placeholder="例如：学习 Rust 或阅读《美丽新世界》" required class="flex-grow px-4 py-3 bg-white dark:bg-slate-800 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                        <button type="submit" class="btn-press px-5 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            <span class="hidden sm:inline ml-2">添加</span>
                        </button>
                    </form>
                </section>

                <section>
                    <h2 class="text-xl font-bold mb-4">我的任务</h2>
                    <div id="tasks-container" class="space-y-3"></div>
                </section>
            </div>

            <!-- Right Column: Stats -->
            <div class="lg:col-span-2">
                <section class="sticky top-8">
                    <h2 class="text-xl font-bold text-center mb-4">时间统计</h2>
                    <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-md">
                        <div class="border-b border-gray-200 dark:border-slate-600">
                            <nav class="-mb-px flex justify-center space-x-2 sm:space-x-4" aria-label="Tabs">
                                <button class="tab-button whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:border-gray-300 transition-colors" onclick="changeTab('daily')">今日</button>
                                <button class="tab-button whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:border-gray-300 transition-colors" onclick="changeTab('weekly')">本周</button>
                                <button class="tab-button whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:border-gray-300 transition-colors" onclick="changeTab('monthly')">本月</button>
                                <button class="tab-button whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:border-gray-300 transition-colors" onclick="changeTab('yearly')">年度</button>
                                <button class="tab-button whitespace-nowrap pb-4 px-1 border-b-2 font-medium text-sm text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:border-gray-300 transition-colors" onclick="changeTab('total')">总计</button>
                            </nav>
                        </div>
                        <div id="stats-summary" class="mt-6 text-center"></div>
                        <div id="stats-container" class="mt-4 space-y-4"></div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Countdown Input Modal -->
    <div id="countdown-input-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center">
            <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">设置倒计时</h3>
            <form id="countdown-input-form">
                <label for="countdown-minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">分钟</label>
                <input type="number" id="countdown-minutes" name="minutes" value="25" min="1" required class="w-full px-4 py-3 text-center text-lg bg-gray-100 dark:bg-slate-700 border border-gray-300 dark:border-slate-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200">
                <div class="mt-6 flex justify-center space-x-4">
                     <button type="button" id="countdown-cancel-btn" class="btn-press px-6 py-2 bg-gray-300 dark:bg-slate-600 text-gray-800 dark:text-gray-100 font-semibold rounded-lg hover:bg-gray-400 dark:hover:bg-slate-500">取消</button>
                    <button type="submit" class="btn-press px-6 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600">开始</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Countdown Display Modal -->
    <div id="countdown-display-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div id="countdown-card" class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center transform transition-all duration-300 scale-95 opacity-0">
            <p id="countdown-task-name" class="text-xl font-bold mb-4"></p>
            <p id="countdown-phase" class="text-lg font-semibold mb-4">专注中</p>
            <div id="countdown-timer" class="text-7xl font-mono font-bold text-green-500 dark:text-green-400 my-6"></div>
            <button id="countdown-stop-btn" class="btn-press w-full px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg>
                停止
            </button>
        </div>
    </div>

    <!-- Delete/Import Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-lg shadow-xl w-11/12 max-w-md text-center">
            <h3 id="confirm-title" class="text-xl font-bold text-gray-900 dark:text-gray-100"></h3>
            <p id="confirm-message" class="text-gray-600 dark:text-gray-300 my-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="btn-press px-6 py-2 bg-gray-300 dark:bg-slate-600 text-gray-800 dark:text-gray-100 font-semibold rounded-lg hover:bg-gray-400 dark:hover:bg-slate-500">取消</button>
                <button id="confirm-action-btn" class="btn-press px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700"></button>
            </div>
        </div>
    </div>


<script>
    // --- DOM Elements ---
    const addTaskForm = document.getElementById('add-task-form');
    const newTaskInput = document.getElementById('new-task-input');
    const tasksContainer = document.getElementById('tasks-container');
    const statsContainer = document.getElementById('stats-container');
    const statsSummary = document.getElementById('stats-summary');
    const tabs = document.querySelectorAll('.tab-button');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const favicon = document.getElementById('favicon');
    
    // Modals
    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmActionBtn = document.getElementById('confirm-action-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    
    const countdownInputModal = document.getElementById('countdown-input-modal');
    const countdownInputForm = document.getElementById('countdown-input-form');
    const countdownCancelBtn = document.getElementById('countdown-cancel-btn');
    const countdownDisplayModal = document.getElementById('countdown-display-modal');
    const countdownCard = document.getElementById('countdown-card');
    const countdownTaskName = document.getElementById('countdown-task-name');
    const countdownTimer = document.getElementById('countdown-timer');
    const countdownStopBtn = document.getElementById('countdown-stop-btn');
    
    // Import/Export
    const importBtn = document.getElementById('import-btn');
    const exportBtn = document.getElementById('export-btn');
    const importFileInput = document.getElementById('import-file-input');

    // --- State Variables ---
    let tasks = [];
    let settings = {};
    let currentTab = 'daily';
    let timerInterval = null;
    let taskToDeleteId = null;
    let taskForCountdownId = null;
    let confirmActionCallback = null;

    // --- Icons ---
    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
    
    const STORAGE_KEY_TASKS = 'tasks_v7';
    const STORAGE_KEY_SETTINGS = 'settings_v7';

    // --- Data & Settings ---
    function loadData() {
        tasks = JSON.parse(localStorage.getItem(STORAGE_KEY_TASKS)) || [];
        settings = JSON.parse(localStorage.getItem(STORAGE_KEY_SETTINGS)) || { theme: 'light' };
    }
    function saveData() {
        localStorage.setItem(STORAGE_KEY_TASKS, JSON.stringify(tasks));
        localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(settings));
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        loadData();
        applySettings();
        restoreInterruptedTimer();
        renderAll();
        changeTab('daily');
        if (Notification.permission !== "granted" && Notification.permission !== "denied") {
            Notification.requestPermission();
        }
    });

    // --- Event Listeners ---
    addTaskForm.addEventListener('submit', handleAddTask);
    themeToggleBtn.addEventListener('click', toggleTheme);
    
    // Modals
    confirmCancelBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
    confirmActionBtn.addEventListener('click', () => {
        if (typeof confirmActionCallback === 'function') {
            confirmActionCallback();
        }
        confirmModal.classList.add('hidden');
    });

    countdownStopBtn.addEventListener('click', () => {
        const runningTask = tasks.find(t => t.countdown);
        if (runningTask) stopTimer(runningTask.id);
    });
    countdownCancelBtn.addEventListener('click', () => countdownInputModal.classList.add('hidden'));
    countdownInputForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const minutes = parseInt(e.target.minutes.value, 10);
        if (taskForCountdownId && minutes > 0) {
            startCountdown(taskForCountdownId, minutes);
            countdownInputModal.classList.add('hidden');
        }
    });

    // Import/Export Listeners
    exportBtn.addEventListener('click', handleExport);
    importBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', handleImport);

    // --- Settings ---
    function applySettings() {
        if (settings.theme === 'dark') {
            document.documentElement.classList.add('dark');
            themeToggleBtn.innerHTML = sunIcon;
        } else {
            document.documentElement.classList.remove('dark');
            themeToggleBtn.innerHTML = moonIcon;
        }
    }
    function toggleTheme() {
        settings.theme = settings.theme === 'light' ? 'dark' : 'light';
        applySettings();
        saveData();
    }

    // --- Task Management ---
    function handleAddTask(e) {
        e.preventDefault();
        const taskName = newTaskInput.value.trim();
        if (!taskName) return;

        const existingInactiveTask = tasks.find(t => t.name === taskName && !t.isActive);

        if (existingInactiveTask) {
            existingInactiveTask.isActive = true;
        } else if (!tasks.some(t => t.name === taskName && t.isActive)) {
            tasks.push({
                id: Date.now(),
                name: taskName,
                isRunning: false,
                elapsedSeconds: 0,
                countdown: null,
                records: [],
                isActive: true
            });
        } else {
            alert("一个同名的活动任务已存在！");
            return;
        }

        newTaskInput.value = '';
        saveData();
        renderAll();
    }
    
    function openConfirmationModal({ title, message, actionText, action, isDestructive = true }) {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmActionBtn.textContent = actionText;
        confirmActionCallback = action;
        
        confirmActionBtn.classList.toggle('bg-red-600', isDestructive);
        confirmActionBtn.classList.toggle('hover:bg-red-700', isDestructive);
        confirmActionBtn.classList.toggle('bg-blue-500', !isDestructive);
        confirmActionBtn.classList.toggle('hover:bg-blue-600', !isDestructive);

        confirmModal.classList.remove('hidden');
    }

    function openDeleteModal(taskId) {
        openConfirmationModal({
            title: '确认移除任务',
            message: '您确定要将此任务从列表中移除吗？它的历史时间记录将被保留在统计中。',
            actionText: '确认移除',
            action: () => handleArchiveTask(taskId)
        });
    }

    function handleArchiveTask(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        if (task.isRunning || task.countdown) stopTimer(taskId);
        task.isActive = false;
        saveData();
        renderAll();
    }
    
    function moveTask(taskId, direction) {
        const activeTasks = tasks.filter(t => t.isActive);
        const index = activeTasks.findIndex(t => t.id === taskId);
        
        if (direction === 'up' && index > 0) {
            const originalIndex = tasks.findIndex(t => t.id === taskId);
            const targetIndex = tasks.findIndex(t => t.id === activeTasks[index - 1].id);
            [tasks[originalIndex], tasks[targetIndex]] = [tasks[targetIndex], tasks[originalIndex]];
        } else if (direction === 'down' && index < activeTasks.length - 1) {
            const originalIndex = tasks.findIndex(t => t.id === taskId);
            const targetIndex = tasks.findIndex(t => t.id === activeTasks[index + 1].id);
            [tasks[originalIndex], tasks[targetIndex]] = [tasks[targetIndex], tasks[originalIndex]];
        }
        
        saveData();
        renderAll();
    }

    // --- Timer Core ---
    function stopAllTimers(exceptTaskId = null) {
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        tasks.forEach(task => {
            if (task.id !== exceptTaskId && (task.isRunning || task.countdown)) {
                stopTimer(task.id, false);
            }
        });
    }

    function handleToggleTimer(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        stopAllTimers(taskId);

        if (task.isRunning) {
            stopTimer(taskId);
        } else {
            startTimer(taskId);
        }
    }
    
    function handleCountdown(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        
        stopAllTimers(taskId);

        if (task.countdown) {
            stopTimer(taskId);
        } else {
            taskForCountdownId = taskId;
            countdownInputModal.classList.remove('hidden');
            document.getElementById('countdown-minutes').focus();
        }
    }

    function startTimer(taskId) {
        const task = tasks.find(t => t.id === taskId);
        task.isRunning = true;
        task.countdown = null;
        
        timerInterval = setInterval(() => {
            task.elapsedSeconds++;
            renderTask(task.id);
            updateTitleAndFavicon(task);
            saveData();
        }, 1000);
        renderAll();
    }
    
    function startCountdown(taskId, minutes) {
        const task = tasks.find(t => t.id === taskId);
        const duration = minutes * 60;
        task.isRunning = false;
        task.countdown = { timeLeft: duration, initialDuration: duration };
        showCountdownDisplayModal(task);

        timerInterval = setInterval(() => {
            task.countdown.timeLeft--;
            if (task.countdown.timeLeft < 0) {
                showNotification("倒计时结束！", `任务 "${task.name}" 已完成。`);
                task.countdown.timeLeft = 0;
                stopTimer(task.id); 
            } else {
                updateCountdownDisplayModal(task);
                updateTitleAndFavicon(task);
                saveData();
            }
        }, 1000);
        renderAll();
    }

    function stopTimer(taskId, doRender = true) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;

        if (task.isRunning && task.elapsedSeconds > 0) {
            task.records.push({ date: new Date().toISOString(), duration: task.elapsedSeconds });
        } else if (task.countdown) {
            const timeSpent = task.countdown.initialDuration - task.countdown.timeLeft;
            if (timeSpent > 0) {
                 task.records.push({ date: new Date().toISOString(), duration: timeSpent });
            }
        }
        
        task.isRunning = false;
        task.countdown = null;
        task.elapsedSeconds = 0;
        
        if (tasks.every(t => !t.isRunning && !t.countdown)) {
            clearInterval(timerInterval);
            timerInterval = null;
            resetTitleAndFavicon();
        }
        
        hideCountdownDisplayModal();
        saveData();
        if (doRender) renderAll();
    }
    
    // --- UI Rendering ---
    function renderAll() {
        renderTasksList();
        renderStats();
    }

    function renderTasksList() {
        tasksContainer.innerHTML = '';
        const activeTasks = tasks.filter(t => t.isActive);

        if (activeTasks.length === 0) {
            tasksContainer.innerHTML = `<div class="bg-white dark:bg-slate-800 p-8 rounded-lg text-center text-gray-500 dark:text-gray-400">还没有任何任务，快添加一个吧！</div>`;
            return;
        }
        activeTasks.forEach((task, index) => {
            tasksContainer.appendChild(createTaskElement(task, index, activeTasks.length));
        });
    }
    
    function renderTask(taskId) {
        const task = tasks.find(t => t.id === taskId);
        const element = document.getElementById(`task-${taskId}`);
        if (element && task && !task.countdown) {
            element.querySelector('.task-time').textContent = formatTime(task.elapsedSeconds);
        }
    }

    function createTaskElement(task, index, totalActive) {
        const div = document.createElement('div');
        div.id = `task-${task.id}`;
        
        let extraClasses = '';
        if (task.countdown) {
            extraClasses = 'countdown-active-indicator';
        } else if (task.isRunning) {
            extraClasses = 'regular-active-indicator';
        }

        div.className = `task-item bg-white dark:bg-slate-800 p-4 border-2 border-transparent dark:border-slate-700 rounded-lg flex items-center justify-between shadow-sm mb-3 ${extraClasses}`;
        
        const isTiming = task.isRunning || task.countdown;

        div.innerHTML = `
            <div class="flex items-center flex-grow min-w-0">
                <div class="flex flex-col items-center mr-3 space-y-2">
                    <button onclick="moveTask(${task.id}, 'up')" class="p-1 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 disabled:opacity-25 disabled:cursor-not-allowed" ${index === 0 ? 'disabled' : ''}>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                    <button onclick="moveTask(${task.id}, 'down')" class="p-1 text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 disabled:opacity-25 disabled:cursor-not-allowed" ${index === totalActive - 1 ? 'disabled' : ''}>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
                <div class="flex-grow min-w-0">
                    <p class="font-semibold truncate">${task.name}</p>
                    <p class="text-2xl font-mono font-bold task-time">${formatTime(task.elapsedSeconds)}</p>
                </div>
            </div>
            <div class="flex items-center flex-shrink-0 space-x-2 ml-2">
                <button onclick="handleToggleTimer(${task.id})" class="btn-press p-3 rounded-full transition-colors ${isTiming ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white" title="常规计时">
                    ${isTiming 
                        ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` 
                        : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`
                    }
                </button>
                <button onclick="handleCountdown(${task.id})" class="btn-press p-3 rounded-full transition-colors ${task.countdown ? 'bg-amber-600 hover:bg-amber-700' : 'bg-amber-400 hover:bg-amber-500'} text-white" title="倒计时">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                </button>
                <button onclick="openDeleteModal(${task.id})" class="btn-press p-3 rounded-full bg-gray-400 hover:bg-gray-500 dark:bg-slate-600 dark:hover:bg-slate-500 text-white transition-colors" title="移除任务">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                </button>
            </div>
        `;
        return div;
    }

    // --- Countdown Modals ---
    function showCountdownDisplayModal(task) {
        countdownDisplayModal.classList.remove('hidden');
        setTimeout(() => {
            countdownCard.classList.remove('scale-95', 'opacity-0');
        }, 10);
        updateCountdownDisplayModal(task);
    }
    function updateCountdownDisplayModal(task) {
        if (!task.countdown) return;
        countdownTaskName.textContent = task.name;
        countdownTimer.textContent = formatTime(task.countdown.timeLeft);
    }
    function hideCountdownDisplayModal() {
        countdownCard.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            countdownDisplayModal.classList.add('hidden');
        }, 300);
    }

    // --- Stats Rendering ---
    function renderStats() {
        statsContainer.innerHTML = '';
        const data = getAggregatedData(currentTab);
        const sortedTasks = Object.entries(data).sort((a, b) => b[1] - a[1]);
        const totalPeriodSeconds = sortedTasks.reduce((sum, [, duration]) => sum + duration, 0);

        statsSummary.innerHTML = `<p class="text-gray-600 dark:text-gray-300">总计专注: <span class="font-bold text-blue-600 dark:text-blue-400 text-lg">${formatTime(totalPeriodSeconds)}</span></p>`;

        if (sortedTasks.length === 0) {
            statsContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-10">暂无记录</div>`;
            return;
        }

        sortedTasks.forEach(([taskName, duration]) => {
            const percentage = totalPeriodSeconds > 0 ? (duration / totalPeriodSeconds) * 100 : 0;
            const statItem = document.createElement('div');
            statItem.className = 'space-y-2';
            statItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-medium text-sm truncate">${taskName}</span>
                    <span class="font-semibold text-sm">${formatTime(duration)}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-slate-700 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
            `;
            statsContainer.appendChild(statItem);
        });
    }
    
    function getAggregatedData(period) {
        const aggregated = {};
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        let startDate;

        switch (period) {
            case 'daily': startDate = today; break;
            case 'weekly':
                const dayOfWeek = now.getDay();
                const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                startDate = new Date(today.getTime() - diff * 24 * 60 * 60 * 1000);
                break;
            case 'monthly': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
            case 'yearly': startDate = new Date(now.getFullYear(), 0, 1); break;
            case 'total': startDate = new Date(0); break;
        }

        tasks.forEach(task => {
            const totalDuration = task.records
                .filter(record => new Date(record.date) >= startDate)
                .reduce((sum, record) => sum + record.duration, 0);
            
            if (totalDuration > 0) {
                if (!aggregated[task.name]) aggregated[task.name] = 0;
                aggregated[task.name] += totalDuration;
            }
        });
        return aggregated;
    }

    window.changeTab = function(tabName) {
        currentTab = tabName;
        tabs.forEach(tab => {
            tab.classList.toggle('active', tab.getAttribute('onclick').includes(`'${tabName}'`));
        });
        renderStats();
    }

    // --- State Recovery & Title/Favicon ---
    function restoreInterruptedTimer() {
        const runningTask = tasks.find(t => t.isRunning || t.countdown);
        if (runningTask) {
            if(runningTask.isRunning) startTimer(runningTask.id);
            if(runningTask.countdown) startCountdown(runningTask.id, runningTask.countdown.timeLeft / 60);
        }
    }
    
    function updateTitleAndFavicon(task) {
        const time = task.countdown ? task.countdown.timeLeft : task.elapsedSeconds;
        const timeString = formatTime(time);
        document.title = `${timeString} - ${task.name}`;
        
        const canvas = document.createElement('canvas');
        canvas.width = 32;
        canvas.height = 32;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = task.countdown ? '#f59e0b' : '#3b82f6'; // Amber for Countdown, Blue for regular timer
        ctx.beginPath();
        ctx.arc(16, 16, 16, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = 'bold 16px sans-serif';
        const minutes = Math.floor(time / 60);
        ctx.fillText(minutes > 99 ? '99+' : minutes, 16, 17);
        favicon.href = canvas.toDataURL('image/png');
    }

    function resetTitleAndFavicon() {
        document.title = '时间记录器';
        favicon.href = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏰</text></svg>`;
    }

    // --- Import / Export ---
    function handleExport() {
        const dataToExport = {
            tasks: tasks,
            settings: settings
        };
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `self-discipline-data-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function handleImport(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData && importedData.tasks && importedData.settings) {
                    openConfirmationModal({
                        title: '确认导入数据',
                        message: '这将覆盖您当前的所有任务和设置。此操作无法撤销。',
                        actionText: '确认导入',
                        action: () => {
                            localStorage.setItem(STORAGE_KEY_TASKS, JSON.stringify(importedData.tasks));
                            localStorage.setItem(STORAGE_KEY_SETTINGS, JSON.stringify(importedData.settings));
                            // Reload everything from the new data
                            loadData();
                            applySettings();
                            renderAll();
                            changeTab('daily');
                        },
                        isDestructive: true
                    });
                } else {
                    alert('文件格式无效，请确保导入正确的文件。');
                }
            } catch (error) {
                alert('导入失败，文件可能已损坏或格式不正确。');
                console.error("Import error:", error);
            } finally {
                // Reset file input to allow importing the same file again
                importFileInput.value = '';
            }
        };
        reader.readAsText(file);
    }


    // --- Helpers ---
    function formatTime(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const secs = totalSeconds % 60;
        return [hours, minutes, secs].map(v => v.toString().padStart(2, '0')).join(':');
    }
    
    function showNotification(title, body) {
        if (Notification.permission === "granted") {
            new Notification(title, { body: body });
        }
    }

</script>

</body>
</html>
