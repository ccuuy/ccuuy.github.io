<!DOCTYPE html>
<html lang="zh-CN" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>时间记录器</title>
    <link id="favicon" rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏳</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS Dark Mode Configuration
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': {
                            '50': '#eff6ff',
                            '100': '#dbeafe',
                            '200': '#bfdbfe',
                            '300': '#93c5fd',
                            '400': '#60a5fa',
                            '500': '#3b82f6',
                            '600': '#2563eb',
                            '700': '#1d4ed8',
                            '800': '#1e40af',
                            '900': '#1e3a8a',
                            '950': '#172554',
                        },
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .tab-button.active {
            color: #3b82f6;
            background-color: #dbeafe;
        }
        html.dark .tab-button.active {
            color: #dbeafe;
            background-color: #1e40af;
        }
        .btn-press:active {
            transform: scale(0.98);
            transition: transform 0.1s ease-in-out;
        }
        .task-card.running-regular {
            border-left-color: #3b82f6 !important;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1), 0 2px 4px -1px rgba(59, 130, 246, 0.06);
        }
        html.dark .task-card.running-regular {
            border-left-color: #60a5fa !important;
            box-shadow: 0 4px 6px -1px rgba(96, 165, 250, 0.1), 0 2px 4px -1px rgba(96, 165, 250, 0.06);
        }
        .task-card.running-countdown {
            border-left-color: #f59e0b !important;
            box-shadow: 0 4px 6px -1px rgba(245, 158, 11, 0.1), 0 2px 4px -1px rgba(245, 158, 11, 0.06);
        }
        html.dark .task-card.running-countdown {
            border-left-color: #fcd34d !important;
            box-shadow: 0 4px 6px -1px rgba(252, 211, 77, 0.1), 0 2px 4px -1px rgba(252, 211, 77, 0.06);
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 transition-colors duration-300">

    <div id="app-container" class="w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 hidden">
        <header class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-3">
                <div class="text-2xl">⏳</div>
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 dark:text-white">时间<span class="text-primary-500">记录器</span></h1>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-4">
                <div id="user-info" class="hidden sm:flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-primary-100 dark:bg-primary-800 flex items-center justify-center text-primary-500 dark:text-primary-300 font-bold" id="user-avatar"></div>
                    <span class="text-sm font-medium text-gray-600 dark:text-gray-300" id="user-email"></span>
                </div>
                <button id="theme-toggle-btn" title="切换主题" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none transition-colors">
                </button>
                <button id="logout-btn" title="登出" class="p-2 rounded-full text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                </button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div class="lg:col-span-3 space-y-8">
                <section class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold mb-4">添加新任务</h2>
                    <form id="add-task-form" class="flex items-center space-x-3">
                        <input type="text" id="new-task-input" placeholder="例如：学习 Rust 或阅读《美丽新世界》" required class="flex-grow px-4 py-3 bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-primary-500 focus:ring-0 rounded-lg transition duration-200">
                        <button type="submit" class="btn-press px-5 py-3 bg-primary-500 text-white font-semibold rounded-lg shadow-md hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-800 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            <span class="hidden sm:inline ml-2">添加</span>
                        </button>
                    </form>
                </section>

                <section>
                    <div class="flex justify-between items-center mb-4">
                         <h2 class="text-xl font-bold">我的任务</h2>
                    </div>
                    <div id="tasks-container" class="space-y-3"></div>
                </section>

                <footer id="quote-footer" class="text-center pt-4 text-sm text-gray-400 dark:text-gray-500 transition-opacity duration-500">
                </footer>
            </div>

            <div class="lg:col-span-2">
                <section class="sticky top-8 bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold text-center mb-4">时间统计</h2>
                    <div id="stats-summary" class="mt-6 text-center"></div>
                    <div id="heatmap-container" class="mt-8"></div>
                    <div class="border-b border-gray-200 dark:border-gray-700 mt-6">
                        <nav class="flex justify-center space-x-1" aria-label="Tabs">
                            <button class="tab-button whitespace-nowrap py-2 px-3 rounded-md font-medium text-sm text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" onclick="changeTab('daily')">今日</button>
                            <button class="tab-button whitespace-nowrap py-2 px-3 rounded-md font-medium text-sm text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" onclick="changeTab('weekly')">本周</button>
                            <button class="tab-button whitespace-nowrap py-2 px-3 rounded-md font-medium text-sm text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" onclick="changeTab('monthly')">本月</button>
                            <button class="tab-button whitespace-nowrap py-2 px-3 rounded-md font-medium text-sm text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" onclick="changeTab('total')">总计</button>
                        </nav>
                    </div>
                    <div id="stats-container" class="mt-4 space-y-4"></div>
                </section>
            </div>
        </main>
    </div>

    <div id="auth-modal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 opacity-0 invisible">
        <div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center transform scale-95">
            <div class="text-5xl mb-4">⏳</div>
            <h3 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-2">欢迎回来</h3>
            <p id="login-quote" class="text-gray-500 dark:text-gray-400 mb-6 text-sm">让每一秒，都有它的意义。</p>
            <form id="auth-form">
                <input type="email" id="email-input" placeholder="电子邮箱" required class="w-full px-4 py-3 mb-4 bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-primary-500 focus:ring-0 rounded-lg transition duration-200">
                <input type="password" id="password-input" placeholder="密码 (至少6位)" required class="w-full px-4 py-3 mb-4 bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-primary-500 focus:ring-0 rounded-lg transition duration-200">
                <p id="auth-error" class="text-red-500 text-sm mb-4 h-5"></p>
                <div class="mt-2 flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4">
                    <button type="button" id="login-btn" class="btn-press w-full px-6 py-3 bg-primary-500 text-white font-semibold rounded-lg shadow-md hover:bg-primary-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 dark:focus:ring-offset-gray-800 transition-all">登录</button>
                    <button type="button" id="signup-btn" class="btn-press w-full px-6 py-3 bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-all">注册</button>
                </div>
            </form>
        </div>
    </div>

    <div id="countdown-input-modal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 opacity-0 invisible">
        <div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center transform scale-95">
            <h3 class="text-xl font-bold text-gray-900 dark:text-gray-100 mb-4">设置倒计时</h3>
            <form id="countdown-input-form">
                <label for="countdown-minutes" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">分钟</label>
                <input type="number" id="countdown-minutes" name="minutes" value="25" min="1" required class="w-full px-4 py-3 text-center text-lg bg-gray-100 dark:bg-gray-700 border-2 border-transparent focus:border-primary-500 focus:ring-0 rounded-lg transition duration-200">
                <div class="mt-6 flex justify-center space-x-4">
                     <button type="button" id="countdown-cancel-btn" class="btn-press px-6 py-2 bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">取消</button>
                    <button type="submit" class="btn-press px-6 py-2 bg-primary-500 text-white font-semibold rounded-lg shadow-md hover:bg-primary-600">开始</button>
                </div>
            </form>
        </div>
    </div>

    <div id="countdown-display-modal" class="modal hidden fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 opacity-0 invisible">
        <div id="countdown-card" class="modal-content bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-11/12 max-w-sm text-center transform scale-95">
            <p id="countdown-task-name" class="text-xl font-bold mb-4"></p>
            <p id="countdown-phase" class="text-lg font-semibold mb-4 text-amber-500">专注中</p>
            <div id="countdown-timer" class="text-7xl font-mono font-bold text-amber-500 dark:text-amber-400 my-6"></div>
            <button id="countdown-stop-btn" class="btn-press w-full px-6 py-3 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 001-1V8a1 1 0 00-1-1H8z" clip-rule="evenodd" /></svg>
                停止
            </button>
        </div>
    </div>

    <div id="confirm-modal" class="modal hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 opacity-0 invisible">
        <div class="modal-content bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl w-11/12 max-w-md text-center transform scale-95">
            <h3 id="confirm-title" class="text-xl font-bold text-gray-900 dark:text-gray-100"></h3>
            <p id="confirm-message" class="text-gray-600 dark:text-gray-300 my-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirm-cancel-btn" class="btn-press px-6 py-2 bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">取消</button>
                <button id="confirm-action-btn" class="btn-press px-6 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700"></button>
            </div>
        </div>
    </div>

    <div id="heatmap-tooltip" class="absolute z-10 hidden px-3 py-2 text-sm text-white bg-gray-900 rounded-md shadow-lg dark:bg-gray-700 pointer-events-none text-center" style="max-width: 200px;"></div>


<script type="module">
    // --- Firebase SDK Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
        getFirestore,
        doc,
        setDoc,
        getDoc
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // --- Firebase Configuration ---
    const firebaseConfig = {
        apiKey: "AIzaSyBsZi3vnMTkkBz9K_2SV0IBC-BekVgvJBo",
        authDomain: "timer-backend.firebaseapp.com",
        projectId: "timer-backend",
        storageBucket: "timer-backend.appspot.com",
        messagingSenderId: "848990917419",
        appId: "1:848990917419:web:f0d5b58e901cbaad802b6e",
        measurementId: "G-S5G0Y35C3P"
    };

    // --- Initialize Firebase ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM Elements ---
    const appContainer = document.getElementById('app-container');
    const addTaskForm = document.getElementById('add-task-form');
    const newTaskInput = document.getElementById('new-task-input');
    const tasksContainer = document.getElementById('tasks-container');
    const statsContainer = document.getElementById('stats-container');
    const statsSummary = document.getElementById('stats-summary');
    const tabs = document.querySelectorAll('.tab-button');
    const themeToggleBtn = document.getElementById('theme-toggle-btn');
    const favicon = document.getElementById('favicon');
    const heatmapContainer = document.getElementById('heatmap-container');
    const heatmapTooltip = document.getElementById('heatmap-tooltip');
    
    // Auth Elements
    const authModal = document.getElementById('auth-modal');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const loginBtn = document.getElementById('login-btn');
    const signupBtn = document.getElementById('signup-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userEmailEl = document.getElementById('user-email');
    const userAvatarEl = document.getElementById('user-avatar');
    const authError = document.getElementById('auth-error');
    const quoteFooter = document.getElementById('quote-footer');

    // Modals
    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmActionBtn = document.getElementById('confirm-action-btn');
    const confirmCancelBtn = document.getElementById('confirm-cancel-btn');
    
    const countdownInputModal = document.getElementById('countdown-input-modal');
    const countdownInputForm = document.getElementById('countdown-input-form');
    const countdownCancelBtn = document.getElementById('countdown-cancel-btn');
    const countdownDisplayModal = document.getElementById('countdown-display-modal');
    const countdownTaskName = document.getElementById('countdown-task-name');
    const countdownTimer = document.getElementById('countdown-timer');
    const countdownStopBtn = document.getElementById('countdown-stop-btn');
    
    // --- State Variables ---
    let tasks = [];
    let settings = {};
    let currentTab = 'daily';
    let globalTimerInterval = null;
    let taskForCountdownId = null;
    let confirmActionCallback = null;
    let currentUserId = null;
    let heatmapDate = new Date(); // State for the currently displayed month in the heatmap

    // --- Constants ---
    const motivationalQuotes = [
      "今日的专注，是明日的成就。",
      "让每一秒，都有它的意义。",
      "时间之流，因专注而深刻。",
      "始于足下，成于专注。",
      "每一次记录，都是向前的足迹。",
      "投入的每一分钟，都在塑造未来。"
    ];
    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`;
    
    // --- Modal Helpers ---
    function showModal(modalElement) {
        modalElement.classList.remove('hidden');
        setTimeout(() => {
            modalElement.classList.remove('opacity-0', 'invisible');
            modalElement.querySelector('.modal-content').classList.remove('scale-95');
        }, 10);
    }

    function hideModal(modalElement) {
        modalElement.classList.add('opacity-0');
        modalElement.querySelector('.modal-content').classList.add('scale-95');
        setTimeout(() => {
            modalElement.classList.add('invisible', 'hidden');
        }, 300);
    }
    
    // --- Firebase Auth Logic ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUserId = user.uid;
            hideModal(authModal);
            appContainer.classList.remove('hidden');
            userEmailEl.textContent = user.email;
            userAvatarEl.textContent = user.email.charAt(0).toUpperCase();
            
            const randomQuote = motivationalQuotes[Math.floor(Math.random() * motivationalQuotes.length)];
            quoteFooter.textContent = `"${randomQuote}"`;

            await loadData();
            applySettings();
            restoreInterruptedTimer();
            renderAll();
            changeTab('daily');
        } else {
            currentUserId = null;
            showModal(authModal);
            appContainer.classList.add('hidden');
            tasks = [];
            settings = { theme: 'light' };
            if (globalTimerInterval) clearInterval(globalTimerInterval);
            resetTitleAndFavicon();
            renderAll();
        }
    });

    loginBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        authError.textContent = '';
        try {
            await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        } catch (error) {
            authError.textContent = '登录失败，请检查邮箱或密码。';
        }
    });

    signupBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        authError.textContent = '';
        try {
            await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        } catch (error) {
            authError.textContent = '注册失败，或邮箱已被使用。';
        }
    });

    logoutBtn.addEventListener('click', () => {
        signOut(auth);
    });

    // --- Data & Settings (Firestore) ---
    async function loadData() {
        if (!currentUserId) return;
        const docRef = doc(db, "users", currentUserId);
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                tasks = data.tasks || [];
                settings = data.settings || { theme: 'light' };
            } else {
                tasks = [];
                settings = { theme: 'light' };
                await saveData();
            }
        } catch (error) {
            console.error("Error loading data:", error);
            tasks = [];
            settings = { theme: 'light' };
        }
    }

    async function saveData() {
        if (!currentUserId) return;
        const docRef = doc(db, "users", currentUserId);
        try {
            const tasksToSave = tasks.map(t => {
                const { isRunning, elapsedSeconds, ...rest } = t;
                return rest;
            });
            await setDoc(docRef, { tasks: tasksToSave, settings: settings });
        } catch (error) {
            console.error("Error saving data:", error);
        }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        applySettings();
    });

    // --- Event Listeners ---
    addTaskForm.addEventListener('submit', handleAddTask);
    themeToggleBtn.addEventListener('click', toggleTheme);
    
    // Add backdrop click listener only to dismissible modals
    [confirmModal, countdownInputModal, countdownDisplayModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
            // Only hide if the click is on the backdrop itself, not the content
            if (e.target === modal) {
                hideModal(modal);
            }
        });
    });
    
    // Explicit cancel button listeners
    confirmCancelBtn.addEventListener('click', () => hideModal(confirmModal));
    confirmActionBtn.addEventListener('click', () => {
        if (typeof confirmActionCallback === 'function') {
            confirmActionCallback();
        }
        hideModal(confirmModal);
    });

    countdownStopBtn.addEventListener('click', () => {
        const runningTask = tasks.find(t => t.isRunning);
        if (runningTask) stopTimer(runningTask.id);
    });
    countdownCancelBtn.addEventListener('click', () => hideModal(countdownInputModal));
    countdownInputForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const minutes = parseInt(e.target.minutes.value, 10);
        if (taskForCountdownId && minutes > 0) {
            startCountdown(taskForCountdownId, minutes);
            hideModal(countdownInputModal);
        }
    });

    // --- Heatmap Event Listeners ---
    heatmapContainer.addEventListener('mouseover', handleHeatmapMouseover);
    heatmapContainer.addEventListener('mouseout', handleHeatmapMouseout);
    document.addEventListener('mousemove', handleHeatmapMousemove);

    // --- Settings ---
    function applySettings() {
        if (settings.theme === 'dark') {
            document.documentElement.classList.add('dark');
            themeToggleBtn.innerHTML = sunIcon;
        } else {
            document.documentElement.classList.remove('dark');
            themeToggleBtn.innerHTML = moonIcon;
        }
    }
    function toggleTheme() {
        settings.theme = settings.theme === 'light' ? 'dark' : 'light';
        applySettings();
        saveData();
    }

    // --- Task Management ---
    function handleAddTask(e) {
        e.preventDefault();
        const taskName = newTaskInput.value.trim();
        if (!taskName) return;

        const existingInactiveTask = tasks.find(t => t.name === taskName && !t.isActive);

        if (existingInactiveTask) {
            existingInactiveTask.isActive = true;
        } else if (!tasks.some(t => t.name === taskName && t.isActive)) {
            tasks.push({
                id: Date.now(),
                name: taskName,
                timerState: null,
                records: [],
                isActive: true,
                isRunning: false, 
                elapsedSeconds: 0 
            });
        } else {
            openConfirmationModal({
                title: '任务已存在',
                message: '一个同名的活动任务已存在！',
                actionText: '好的',
                action: () => {},
                isDestructive: false
            });
            return;
        }

        newTaskInput.value = '';
        saveData();
        renderAll();
    }
    
    function openConfirmationModal({ title, message, actionText, action, isDestructive = true }) {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmActionBtn.textContent = actionText;
        confirmActionCallback = action;
        
        confirmActionBtn.classList.toggle('bg-red-600', isDestructive);
        confirmActionBtn.classList.toggle('hover:bg-red-700', isDestructive);
        confirmActionBtn.classList.toggle('bg-primary-500', !isDestructive);
        confirmActionBtn.classList.toggle('hover:bg-primary-600', !isDestructive);

        showModal(confirmModal);
    }

    function openDeleteModal(taskId) {
        openConfirmationModal({
            title: '确认移除任务',
            message: '您确定要将此任务从列表中移除吗？它的历史时间记录将被保留在统计中。',
            actionText: '确认移除',
            action: () => handleArchiveTask(taskId)
        });
    }

    function handleArchiveTask(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        if (task.isRunning) stopTimer(taskId);
        task.isActive = false;
        saveData();
        renderAll();
    }
    
    function moveTask(taskId, direction) {
        const activeTasks = tasks.filter(t => t.isActive);
        const index = activeTasks.findIndex(t => t.id === taskId);
        
        if (direction === 'up' && index > 0) {
            const originalIndex = tasks.findIndex(t => t.id === taskId);
            const targetIndex = tasks.findIndex(t => t.id === activeTasks[index - 1].id);
            [tasks[originalIndex], tasks[targetIndex]] = [tasks[targetIndex], tasks[originalIndex]];
        } else if (direction === 'down' && index < activeTasks.length - 1) {
            const originalIndex = tasks.findIndex(t => t.id === taskId);
            const targetIndex = tasks.findIndex(t => t.id === activeTasks[index + 1].id);
            [tasks[originalIndex], tasks[targetIndex]] = [tasks[targetIndex], tasks[originalIndex]];
        }
        
        saveData();
        renderAll();
    }

    // --- Timer Core ---
    function stopAllTimers(exceptTaskId = null) {
        if (globalTimerInterval) {
            clearInterval(globalTimerInterval);
            globalTimerInterval = null;
        }
        tasks.forEach(task => {
            if (task.id !== exceptTaskId && task.isRunning) {
                stopTimer(task.id, false);
            }
        });
    }

    function handleToggleTimer(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        stopAllTimers(taskId);
        if (task.isRunning) stopTimer(taskId);
        else startTimer(taskId);
    }
    
    function handleCountdown(taskId) {
        const task = tasks.find(t => t.id === taskId);
        if (!task) return;
        stopAllTimers(taskId);
        if (task.isRunning) {
            stopTimer(taskId);
        } else {
            taskForCountdownId = taskId;
            showModal(countdownInputModal);
            document.getElementById('countdown-minutes').focus();
        }
    }

    function startMasterTimer() {
        if (globalTimerInterval) return;
        globalTimerInterval = setInterval(() => {
            const runningTask = tasks.find(t => t.isRunning);
            if (runningTask) {
                const state = runningTask.timerState;
                if (state.type === 'regular') {
                    runningTask.elapsedSeconds = Math.floor((Date.now() - state.startTime) / 1000);
                } else if (state.type === 'countdown') {
                    const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                    runningTask.elapsedSeconds = state.initialDuration - elapsed;
                    if (runningTask.elapsedSeconds < 0) {
                        stopTimer(runningTask.id);
                    }
                }
                renderTask(runningTask.id);
                updateTitleAndFavicon(runningTask);
            } else {
                clearInterval(globalTimerInterval);
                globalTimerInterval = null;
            }
        }, 1000);
    }

    function startTimer(taskId) {
        const task = tasks.find(t => t.id === taskId);
        task.isRunning = true;
        task.timerState = { type: 'regular', startTime: Date.now() };
        saveData();
        renderAll();
        startMasterTimer();
    }
    
    function startCountdown(taskId, minutes) {
        const task = tasks.find(t => t.id === taskId);
        const duration = minutes * 60;
        task.isRunning = true;
        task.timerState = { type: 'countdown', startTime: Date.now(), initialDuration: duration };
        showModal(countdownDisplayModal);
        saveData();
        renderAll();
        startMasterTimer();
    }

    function stopTimer(taskId, doRender = true) {
        const task = tasks.find(t => t.id === taskId);
        if (!task || !task.timerState) return;
        const duration = Math.floor((Date.now() - task.timerState.startTime) / 1000);
        if (duration > 0) {
            const finalDuration = task.timerState.type === 'countdown' 
                ? Math.min(duration, task.timerState.initialDuration)
                : duration;
            task.records.push({ date: new Date().toISOString(), duration: finalDuration });
        }
        task.isRunning = false;
        task.timerState = null;
        task.elapsedSeconds = 0;
        if (tasks.every(t => !t.isRunning)) {
            if (globalTimerInterval) clearInterval(globalTimerInterval);
            globalTimerInterval = null;
            resetTitleAndFavicon();
        }
        hideModal(countdownDisplayModal);
        saveData();
        if (doRender) renderAll();
    }
    
    // --- UI Rendering ---
    function renderAll() {
        renderTasksList();
        renderStats();
        renderMonthlyHeatmap();
    }

    function renderTasksList() {
        tasksContainer.innerHTML = '';
        const activeTasks = tasks.filter(t => t.isActive);
        if (activeTasks.length === 0) {
            tasksContainer.innerHTML = `<div class="bg-white dark:bg-gray-800 p-8 rounded-2xl text-center text-gray-500 dark:text-gray-400 shadow-sm">
                <p class="text-lg">还没有任何任务</p>
                <p class="mt-2 text-sm">"始于足下，成于专注。"</p>
            </div>`;
            return;
        }
        activeTasks.forEach((task, index) => {
            tasksContainer.appendChild(createTaskElement(task, index, activeTasks.length));
        });
    }
    
    function renderTask(taskId) {
        const task = tasks.find(t => t.id === taskId);
        const element = document.getElementById(`task-${taskId}`);
        if (element && task) {
            const timeToDisplay = task.timerState?.type === 'countdown' 
                ? task.elapsedSeconds > 0 ? task.elapsedSeconds : 0
                : task.elapsedSeconds;
            element.querySelector('.task-time').textContent = formatTime(timeToDisplay);
            if (task.timerState?.type === 'countdown') {
                updateCountdownDisplayModal(task);
            }
        }
    }

    function createTaskElement(task, index, totalActive) {
        const div = document.createElement('div');
        div.id = `task-${task.id}`;
        
        let runningClass = '';
        if (task.isRunning) {
            runningClass = task.timerState.type === 'countdown' 
                ? 'running-countdown' 
                : 'running-regular';
        }

        div.className = `task-card bg-white dark:bg-gray-800 p-4 rounded-xl flex items-center justify-between shadow-sm transition-all duration-300 border-l-4 border-transparent ${runningClass}`;
        
        const isTiming = task.isRunning;

        div.innerHTML = `
            <div class="flex items-center flex-grow min-w-0">
                <div class="flex flex-col items-center self-stretch justify-center px-2 space-y-3">
                    <button onclick="moveTask(${task.id}, 'up')" class="p-1 text-gray-400 hover:text-primary-500 dark:hover:text-primary-400 disabled:opacity-25 disabled:cursor-not-allowed transition-colors" ${index === 0 ? 'disabled' : ''}>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                    <button onclick="moveTask(${task.id}, 'down')" class="p-1 text-gray-400 hover:text-primary-500 dark:hover:text-primary-400 disabled:opacity-25 disabled:cursor-not-allowed transition-colors" ${index === totalActive - 1 ? 'disabled' : ''}>
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
                <div class="flex-grow min-w-0 ml-2">
                    <p class="font-semibold truncate">${task.name}</p>
                    <p class="text-2xl font-mono font-bold text-gray-800 dark:text-white task-time">${formatTime(task.elapsedSeconds || 0)}</p>
                </div>
            </div>
            <div class="flex items-center flex-shrink-0 space-x-2 ml-2">
                <button onclick="handleToggleTimer(${task.id})" class="btn-press p-3 rounded-full transition-colors ${isTiming && task.timerState?.type === 'regular' ? 'bg-yellow-100 text-yellow-600 dark:bg-yellow-800 dark:text-yellow-300' : 'bg-primary-100 text-primary-600 dark:bg-primary-800 dark:text-primary-300 hover:bg-primary-200 dark:hover:bg-primary-700'}" title="常规计时">
                    ${isTiming && task.timerState?.type === 'regular'
                        ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 9a1 1 0 000 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>` 
                        : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.07v3.86a1 1 0 001.555.832l3.197-1.932a1 1 0 000-1.664L9.555 7.168z" clip-rule="evenodd" /></svg>`
                    }
                </button>
                <button onclick="handleCountdown(${task.id})" class="btn-press p-3 rounded-full transition-colors ${isTiming && task.timerState?.type === 'countdown' ? 'bg-yellow-100 text-yellow-600 dark:bg-yellow-800 dark:text-yellow-300' : 'bg-amber-100 text-amber-600 dark:bg-amber-800 dark:text-amber-300 hover:bg-amber-200 dark:hover:bg-amber-700'}" title="倒计时">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-13a.75.75 0 00-1.5 0v5c0 .414.336.75.75.75h4a.75.75 0 000-1.5h-3.25V5z" clip-rule="evenodd" /></svg>
                </button>
                <button onclick="openDeleteModal(${task.id})" class="btn-press p-3 rounded-full bg-gray-100 text-gray-500 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600 transition-colors" title="移除任务">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                </button>
            </div>
        `;
        return div;
    }

    // --- Countdown Modals ---
    function updateCountdownDisplayModal(task) {
        if (!task.isRunning || task.timerState?.type !== 'countdown') return;
        const timeToDisplay = task.elapsedSeconds > 0 ? task.elapsedSeconds : 0;
        countdownTaskName.textContent = task.name;
        countdownTimer.textContent = formatTime(timeToDisplay);
    }

    // --- Stats Rendering ---
    function renderStats() {
        statsContainer.innerHTML = '';
        const data = getAggregatedData(currentTab);
        const sortedTasks = Object.entries(data).sort((a, b) => b[1] - a[1]);
        const totalPeriodSeconds = sortedTasks.reduce((sum, [, duration]) => sum + duration, 0);

        statsSummary.innerHTML = `<p class="text-gray-500 dark:text-gray-400 mt-2">总计专注时长</p><p class="font-bold text-primary-500 text-4xl">${formatTime(totalPeriodSeconds)}</p>`;

        if (sortedTasks.length === 0) {
            statsContainer.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-10">暂无记录</div>`;
            return;
        }

        const maxDuration = sortedTasks.length > 0 ? sortedTasks[0][1] : 0;

        sortedTasks.forEach(([taskName, duration]) => {
            const percentage = maxDuration > 0 ? (duration / maxDuration) * 100 : 0;
            const statItem = document.createElement('div');
            statItem.className = 'space-y-2';
            statItem.innerHTML = `
                <div class="flex justify-between items-center text-sm">
                    <span class="font-medium truncate text-gray-700 dark:text-gray-300">${taskName}</span>
                    <span class="font-semibold text-gray-500 dark:text-gray-400">${formatTime(duration)}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                    <div class="bg-primary-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                </div>
            `;
            statsContainer.appendChild(statItem);
        });
    }
    
    function getAggregatedData(period) {
        const aggregated = {};
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        let startDate;

        switch (period) {
            case 'daily': startDate = today; break;
            case 'weekly':
                const dayOfWeek = now.getDay();
                const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Assuming Monday is the first day of the week
                startDate = new Date(today.getTime() - diff * 24 * 60 * 60 * 1000);
                break;
            case 'monthly': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break;
            case 'total': startDate = new Date(0); break;
        }

        tasks.forEach(task => {
            const totalDuration = task.records
                .filter(record => new Date(record.date) >= startDate)
                .reduce((sum, record) => sum + record.duration, 0);
            
            if (totalDuration > 0) {
                if (!aggregated[task.name]) aggregated[task.name] = 0;
                aggregated[task.name] += totalDuration;
            }
        });
        return aggregated;
    }

    window.changeTab = function(tabName) {
        currentTab = tabName;
        tabs.forEach(tab => {
            tab.classList.toggle('active', tab.getAttribute('onclick').includes(`'${tabName}'`));
        });
        renderStats();
    }

    // --- Heatmap Rendering ---
    function handleHeatmapMouseover(e) {
        const target = e.target.closest('[data-date]');
        if (target && target.getAttribute('data-date')) {
            const dateStr = target.getAttribute('data-date');
            const duration = parseInt(target.getAttribute('data-duration'), 10);
            
            const date = new Date(dateStr);
            const formattedDate = date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' });

            const durationText = duration > 0 ? `${formatTime(duration)} 的专注` : '无活动';
            heatmapTooltip.innerHTML = `<strong>${durationText}</strong><br><span class="text-xs text-gray-300">${formattedDate}</span>`;
            
            heatmapTooltip.classList.remove('hidden');
        }
    }

    function handleHeatmapMouseout() {
        heatmapTooltip.classList.add('hidden');
    }

    function handleHeatmapMousemove(e) {
        if (!heatmapTooltip.classList.contains('hidden')) {
            heatmapTooltip.style.left = `${e.pageX + 15}px`;
            heatmapTooltip.style.top = `${e.pageY - 30}px`;
        }
    }

    function getDailyAggregatedData() {
        const dailyTotals = {};
        tasks.forEach(task => {
            task.records.forEach(record => {
                const recordDate = new Date(record.date);
                const dateString = new Date(Date.UTC(recordDate.getFullYear(), recordDate.getMonth(), recordDate.getDate())).toISOString().split('T')[0];
                if (!dailyTotals[dateString]) {
                    dailyTotals[dateString] = 0;
                }
                dailyTotals[dateString] += record.duration;
            });
        });
        return dailyTotals;
    }

    function getHeatmapColor(duration, maxDuration) {
        if (duration <= 0) return 'bg-gray-200 dark:bg-gray-700/60';
        const percentage = maxDuration > 0 ? duration / maxDuration : 0;
        if (percentage > 0.7) return 'bg-primary-700';
        if (percentage > 0.5) return 'bg-primary-600';
        if (percentage > 0.3) return 'bg-primary-400';
        return 'bg-primary-200';
    }

    function renderMonthlyHeatmap() {
        // 1. Get data
        const dailyData = getDailyAggregatedData();
        const values = Object.values(dailyData).filter(d => d > 0);
        values.sort((a, b) => a - b);
        // Use 90th percentile for max to avoid outliers skewing the colors
        const maxDuration = values.length > 0 ? values[Math.floor(values.length * 0.9)] || values[values.length - 1] : 1;

        // 2. Get current month details
        const year = heatmapDate.getFullYear();
        const month = heatmapDate.getMonth();
        const monthName = `${year}年 ${month + 1}月`;

        const firstDayOfMonth = new Date(year, month, 1);
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const startDayOfWeek = firstDayOfMonth.getDay(); // 0 for Sunday, 1 for Monday...

        // 3. Build HTML for days
        let daysHtml = '';
        // Add empty cells for days before the 1st of the month
        for (let i = 0; i < startDayOfWeek; i++) {
            daysHtml += '<div></div>';
        }

        // Add cells for each day of the month
        for (let day = 1; day <= daysInMonth; day++) {
            const currentDate = new Date(Date.UTC(year, month, day));
            const dateString = currentDate.toISOString().split('T')[0];
            const duration = dailyData[dateString] || 0;
            const colorClass = getHeatmapColor(duration, maxDuration);
            
            daysHtml += `<div class="w-full aspect-square rounded-md flex items-center justify-center ${colorClass}" data-date="${dateString}" data-duration="${duration}">
                            <span class="text-xs text-white/70 mix-blend-difference">${day}</span>
                         </div>`;
        }

        // 4. Update the DOM
        heatmapContainer.innerHTML = `
            <div class="flex items-center justify-between mb-2">
                <button id="heatmap-prev-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                </button>
                <h3 id="heatmap-month-year" class="font-semibold text-sm">${monthName}</h3>
                <button id="heatmap-next-btn" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4-4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
            <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 dark:text-gray-400 mb-1">
                <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
            </div>
            <div class="grid grid-cols-7 gap-1">
                ${daysHtml}
            </div>
            <div class="flex justify-end items-center text-xs text-gray-400 dark:text-gray-500 mt-2 space-x-2">
                 <span>少</span>
                 <div class="w-3 h-3 rounded-sm bg-gray-200 dark:bg-gray-700/60"></div>
                 <div class="w-3 h-3 rounded-sm bg-primary-200"></div>
                 <div class="w-3 h-3 rounded-sm bg-primary-400"></div>
                 <div class="w-3 h-3 rounded-sm bg-primary-600"></div>
                 <div class="w-3 h-3 rounded-sm bg-primary-700"></div>
                 <span>多</span>
            </div>
        `;

        // 5. Add event listeners
        document.getElementById('heatmap-prev-btn').addEventListener('click', () => {
            heatmapDate.setMonth(heatmapDate.getMonth() - 1);
            renderMonthlyHeatmap();
        });
        document.getElementById('heatmap-next-btn').addEventListener('click', () => {
            heatmapDate.setMonth(heatmapDate.getMonth() + 1);
            renderMonthlyHeatmap();
        });
    }

    // --- State Recovery & Title/Favicon ---
    function restoreInterruptedTimer() {
        const runningTask = tasks.find(t => t.timerState);
        if (runningTask) {
            runningTask.isRunning = true;
            startMasterTimer();
        }
    }
    
    function updateTitleAndFavicon(task) {
        const time = task.elapsedSeconds > 0 ? task.elapsedSeconds : 0;
        const timeString = formatTime(time);
        document.title = `${timeString} - ${task.name}`;
        
        const canvas = document.createElement('canvas');
        canvas.width = 32;
        canvas.height = 32;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = task.timerState.type === 'countdown' ? '#f59e0b' : '#3b82f6';
        ctx.beginPath();
        ctx.arc(16, 16, 16, 0, 2 * Math.PI);
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = 'bold 16px sans-serif';
        const minutes = Math.floor(time / 60);
        ctx.fillText(minutes > 99 ? '99+' : minutes, 16, 17);
        favicon.href = canvas.toDataURL('image/png');
    }

    function resetTitleAndFavicon() {
        document.title = '时间记录器';
        favicon.href = `data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏳</text></svg>`;
    }
    
    // --- Helpers ---
    function formatTime(totalSeconds) {
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const secs = totalSeconds % 60;
        return [hours, minutes, secs].map(v => v.toString().padStart(2, '0')).join(':');
    }
    
    // --- Expose functions to global scope for onclick attributes ---
    window.moveTask = moveTask;
    window.handleToggleTimer = handleToggleTimer;
    window.handleCountdown = handleCountdown;
    window.openDeleteModal = openDeleteModal;

</script>

</body>
</html>
